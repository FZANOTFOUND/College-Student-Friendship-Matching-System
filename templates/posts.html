{% extends 'base.html' %}

{% block title %}æ‰€æœ‰å¸–å­ - ç¥ç§˜ç¤¾åŒº{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/posts.css') }}">
<style>
/* è¦†ç›–/è¡¥å……æ ·å¼ï¼šä½¿å¸–å­å¡ç‰‡é“ºæ»¡ä¸€è¡Œå¹¶è®©æœç´¢æ¡†å¯¹é½ */
.posts-header {
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: space-between;
  margin-bottom: 18px;
}

/* æœç´¢æ¡†ï¼šæœ€å¤§å®½åº¦å¹¶å“åº”å¼ */
.search-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
}
.search-wrapper input {
  width: 260px;
  max-width: 36vw;
  min-width: 180px;
}

/* å¸–å­åŒºåŸŸï¼šæ¯æ¡å æ»¡æ•´è¡Œ */
#postsContainer .col-12 {
  padding-left: 0;
  padding-right: 0;
}

/* å¡ç‰‡é“ºæ»¡è¡Œå¹¶ç•¥åŠ æ ·å¼ */
.post-full-card {
  width: 100%;
  padding: 18px;
  border-radius: 10px;
  background: #ffffff;
  box-shadow: 0 6px 18px rgba(15,23,42,0.04);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

/* å¡ç‰‡å·¦ä¾§ä¸»ä½“ */
.post-full-main {
  flex: 1 1 auto;
  min-width: 0;
}

/* æ ‡é¢˜å’Œæ‘˜è¦ */
.post-full-title {
  margin: 0 0 6px 0;
  font-size: 1.15rem;
  font-weight: 600;
}
.post-full-meta {
  font-size: 0.88rem;
  color: #6b7280;
  margin-bottom: 8px;
}
.post-full-excerpt {
  color: #374151;
  line-height: 1.6;
  white-space: pre-wrap;
  margin-bottom: 8px;
}

/* å¡ç‰‡å³ä¾§æ“ä½œåŒº */
.post-full-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
  flex: 0 0 auto;
}
.post-stats {
  font-size: 0.9rem;
  color: #4b5563;
}
.view-btn {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #0d6efd;
  color: #0d6efd;
  text-decoration: none;
}
.view-btn:hover {
  background: #0d6efd;
  color: #fff;
}

/* åˆ†é¡µå±…å·¦ï¼ˆå’Œå¡ç‰‡å·¦å¯¹é½ï¼‰ */
nav ul.pagination {
  margin-left: 0;
}

/* å“åº”å¼ï¼šå°å±æ—¶æŠŠactionsæ”¾åˆ°ä¸‹ä¸€è¡Œå³ä¾§ */
@media (max-width: 767.98px) {
  .post-full-card {
    flex-direction: column;
    align-items: stretch;
  }
  .post-full-actions {
    align-items: flex-start;
    flex-direction: row;
    justify-content: space-between;
  }
  .search-wrapper input {
    max-width: 180px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding-top:80px;">

  <!-- header: title + search aligned to right -->
  <div class="posts-header">
    <h4 class="mb-0">æ‰€æœ‰å¸–å­</h4>

    <div class="search-wrapper">
      <input id="searchInput" class="form-control form-control-sm" placeholder="æœç´¢æ ‡é¢˜æˆ–å†…å®¹" />
      <button id="searchBtn" class="btn btn-sm btn-primary">æœç´¢</button>
    </div>
  </div>

  <!-- posts: each row full width -->
  <div id="postsContainer" class="row gy-3"></div>

  <nav>
    <ul class="pagination mt-3" id="postsPagination"></ul>
  </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const perPage = 12;
  let allPosts = [];
  let filtered = [];
  let currentPage = 1;

  function escapeHtml(unsafe){
    if(unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('\"','&quot;').replaceAll("'","&#039;");
  }

  async function loadPosts(){
    try{
      const res = await apiFetch('/api/posts/all', { method: 'GET' });
      if(Array.isArray(res.data)){
        allPosts = res.data;
      } else if(res.data.items && Array.isArray(res.data.items)){
        allPosts = res.data.items;
      } else if(Array.isArray(res.data.data)){
        allPosts = res.data.data;
      } else {
        allPosts = res.data || [];
      }
      filtered = allPosts.slice();
      currentPage = 1;
      renderPage();
    }catch(err){
      console.error(err);
      insertContainer('danger', err.message || 'åŠ è½½å¸–å­å¤±è´¥');
    }
  }

  function renderPage(){
    const container = document.getElementById('postsContainer');
    container.innerHTML = '';
    const start = (currentPage - 1) * perPage;
    const pageItems = filtered.slice(start, start + perPage);
    if(pageItems.length === 0){
      container.innerHTML = '<div class="col-12 text-center text-muted p-4">æš‚æ— å¸–å­</div>';
      renderPagination();
      return;
    }

    pageItems.forEach(p => {
      const excerpt = (p.content || '').slice(0, 300).replaceAll('\n','<br>');
      const author = p.user?.username ?? p.username ?? ('ID:' + (p.user_id ?? ''));
      const created = p.created_at ? new Date(p.created_at).toLocaleString() : '';

      const col = document.createElement('div');
      col.className = 'col-12';

      col.innerHTML = `
        <div class="post-full-card">
          <div class="post-full-main">
            <h5 class="post-full-title">${escapeHtml(p.title || 'ï¼ˆæ— æ ‡é¢˜ï¼‰')}</h5>
            <div class="post-full-meta">${escapeHtml(author)} Â· ${escapeHtml(created)}</div>
            <div class="post-full-excerpt">${excerpt}</div>
          </div>

          <div class="post-full-actions">
            <div class="post-stats">â¤ ${escapeHtml(String(p.likes_count || 0))} Â· ğŸ’¬ ${escapeHtml(String(p.comments_count || 0))} Â· ğŸ‘ ${escapeHtml(String(p.view_count || 0))}</div>
            <a class="view-btn" href="/posts/view?post_id=${encodeURIComponent(p.id)}">æŸ¥çœ‹</a>
          </div>
        </div>
      `;
      container.appendChild(col);
    });

    renderPagination();
  }

  function renderPagination(){
    const ul = document.getElementById('postsPagination');
    ul.innerHTML = '';
    const pages = Math.max(1, Math.ceil(filtered.length / perPage));
    function li(content, cb, active){
      const el = document.createElement('li');
      el.className = 'page-item' + (active? ' active' : '');
      el.innerHTML = `<a class="page-link" href="#">${content}</a>`;
      if(cb) el.addEventListener('click', (e)=>{ e.preventDefault(); cb(); });
      return el;
    }
    ul.appendChild(li('â€¹', ()=>{ if(currentPage>1){ currentPage--; renderPage(); } } ));
    const start = Math.max(1, currentPage - 2);
    const end = Math.min(pages, currentPage + 2);
    for(let i=start;i<=end;i++) ul.appendChild(li(i, ()=>{ currentPage = i; renderPage(); }, i===currentPage));
    ul.appendChild(li('â€º', ()=>{ if(currentPage<pages){ currentPage++; renderPage(); } } ));
  }

  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if(!q) filtered = allPosts.slice();
    else filtered = allPosts.filter(p => (p.title||'').toLowerCase().includes(q) || (p.content||'').toLowerCase().includes(q));
    currentPage = 1; renderPage();
  });

  document.addEventListener('DOMContentLoaded', loadPosts);
})();
</script>
{% endblock %}
