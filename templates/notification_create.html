{% extends "base.html" %}
{% block title %}创建通知{% endblock %}

{% block css %}
<style>
  .notify-wrapper {
    max-width: 900px;
    margin: 24px auto;
    background: #fff;
    padding: 18px;
    border-radius: 8px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.06);
  }

  .form-note {
    font-size: 0.9rem;
    color: #666;
  }

  .field-label {
    font-weight: 600;
  }

  #type-custom-row { display: none; }

  .actions {
    margin-top: 12px;
    display:flex;
    gap: 8px;
  }

  body{
      height: 110vh;
  }
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding-top:75px;">
  <div class="notify-wrapper">
    <h4 class="mb-3">手动创建通知</h4>
    <p class="form-note">仅限管理员或有权限的用户使用。通知会写入指定接收者的消息列表。recipient_id 为用户 ID（整数）。</p>

    <form id="notify-form" novalidate>
      <div class="row g-3">

        <div class="col-12 col-md-6">
          <label class="field-label" for="recipient_id">接收者 ID (recipient_id) *</label>
          <input id="recipient_id" name="recipient_id" type="text" class="form-control" placeholder="例如：42" required>
          <div class="invalid-feedback">请输入接收者 ID。</div>
        </div>

        <div class="col-12 col-md-6">
          <label class="field-label" for="type_select">通知类型 *</label>
          <div class="d-flex gap-2">
            <select id="type_select" class="form-select">
              <option value="message">message（私信）</option>
              <option value="system">system（系统）</option>
              <option value="comment">comment（评论）</option>
              <option value="like">like（点赞）</option>
               <option value="like">info（通知）</option>
            </select>
          </div>
        </div>

        <div class="col-12">
          <label class="field-label" for="content">内容 *</label>
          <textarea id="content" name="content" class="form-control" rows="4" maxlength="2000" required></textarea>
          <div class="invalid-feedback">请输入通知内容。</div>
        </div>

      </div>

      <div class="actions">
        <button type="submit" id="send-btn" class="btn btn-primary">发送通知</button>
        <button type="button" id="reset-btn" class="btn btn-outline-secondary">重置</button>
      </div>
    </form>

    <div id="response-area" class="mt-3"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/*
  notification_create.js (inline)
  - 发送 PUT /api/notification/create
  - CSRF header 从 cookie csrf_access_token 中读取
  - 使用全局 apiFetch/insertContainer/showErrors 时优先调用
*/

(function () {
  const globalApiFetch = window.apiFetch;
  const globalInsertContainer = window.insertContainer;
  const globalShowErrors = window.showErrors;
  const globalGetCookie = window.getCookie;

  function getCookieLocal(name) {
    if (typeof globalGetCookie === 'function') return globalGetCookie(name);
    const m = document.cookie.split('; ').find(r => r.startsWith(name + '='));
    return m ? decodeURIComponent(m.split('=')[1]) : null;
  }

  async function localApiFetch(path, options = {}) {
    options = options || {};
    options.headers = options.headers || {};
    options.credentials = 'include';

    const csrf = getCookieLocal('csrf_access_token');
    if (csrf) options.headers['X-CSRF-TOKEN'] = csrf;

    const res = await fetch(path, options);
    const json = await res.json();
    return json;
  }

  const api = localApiFetch;


  function resetForm() {
    document.getElementById('notify-form').reset();
    clearContainer();
  }

  function getSelectedType() {
    const sel = document.getElementById('type_select').value;
    if (sel === 'custom') {
      return document.getElementById('type_custom').value.trim();
    }
    return sel;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const typeSelect = document.getElementById('type_select');
    const typeCustom = document.getElementById('type_custom');
    const form = document.getElementById('notify-form');

    typeSelect.addEventListener('change', () => {
      if (typeSelect.value === 'custom') {
        typeCustom.style.display = 'block';
        typeCustom.focus();
      } else {
        typeCustom.style.display = 'none';
        typeCustom.value = '';
      }
    });

    document.getElementById('reset-btn').addEventListener('click', (e) => {
      e.preventDefault();
      resetForm();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearContainer();

      // 前端校验
      const recipient = document.getElementById('recipient_id').value.trim();
      const type = getSelectedType();
      const content = document.getElementById('content').value.trim();

      let valid = true;
      if (!recipient) {
        document.getElementById('recipient_id').classList.add('is-invalid');
        valid = false;
      } else {
        document.getElementById('recipient_id').classList.remove('is-invalid');
      }

      if (!type) {
        document.getElementById('type_select').classList.add('is-invalid');
        valid = false;
      } else {
        document.getElementById('type_select').classList.remove('is-invalid');
      }

      if (!content) {
        document.getElementById('content').classList.add('is-invalid');
        valid = false;
      } else {
        document.getElementById('content').classList.remove('is-invalid');
      }


      // 构造 payload（后端期望 recipient_id, type, content）
      const payload = {
        recipient_id: recipient,
        type: type,
        content: content
      };

      try {
        const res = await api('/api/notification/create', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res) {
          insertContainer('danger','服务器无响应');
          return;
        }

        if (res.code === 200) {
          insertContainer('info','通知已创建');
          resetForm();
        } else if (res.code === 400 && res.errors) {
          showErrors(res.errors, 1);
        } else {
          insertContainer('danger','创建失败');
        }
      } catch (err) {
        console.error(err);
        insertContainer('danger','网络或服务器错误');
      }
    });
  });
})();
</script>
{% endblock %}
